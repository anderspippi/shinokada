#!/usr/bin/env bash

set -eu

# shellcheck disable=SC2034
VERSION="0.0.5"
SCRIPT_NAME=$(basename "$0")

# check os
if [[ $(uname) == "Linux" ]]; then
    FIREFOX="/usr/bin/firefox"
    # check if Firefox is running. If it is, ask if the script can close it.
    if pgrep -f firefox; then
        printf "We need to close Firefox in order to proceed. May I close Firefox? (yes/y/no/n)"
        read -r RES
        USER_ANS=$(echo "$RES" | cut -c 1-1 | tr "[:lower:]" "[:upper:]")
        if [ "$USER_ANS" = "Y" ]; then
            killall firefox
        else
            echo "Exiting ..."
            exit
        fi
    fi
elif [[ $(uname) == "Darwin" ]]; then
    FIREFOX="/Applications/Firefox.app/Contents/MacOS/firefox"
fi

readlinkf() {
    [ "${1:-}" ] || return 1
    max_symlinks=40
    CDPATH='' # to avoid changing to an unexpected directory

    target=$1
    [ -e "${target%/}" ] || target=${1%"${1##*[!/]}"} # trim trailing slashes
    [ -d "${target:-/}" ] && target="$target/"

    cd -P . 2>/dev/null || return 1
    while [ "$max_symlinks" -ge 0 ] && max_symlinks=$((max_symlinks - 1)); do
        if [ ! "$target" = "${target%/*}" ]; then
            case $target in
            /*) cd -P "${target%/*}/" 2>/dev/null || break ;;
            *) cd -P "./${target%/*}" 2>/dev/null || break ;;
            esac
            target=${target##*/}
        fi

        if [ ! -L "$target" ]; then
            target="${PWD%/}${target:+/}${target}"
            printf '%s\n' "${target:-/}"
            return 0
        fi
        link=$(ls -dl -- "$target" 2>/dev/null) || break
        target=${link#*" $target -> "}
    done
    return 1
}

self=$(readlinkf "$0")
script_dir=${self%/*}
# echo "$script_dir"

# Variables for options
VAR_ALIGN="Text alignment. Default: center."
VAR_BCOLOR="Background color. Enclose with quotes."
VAR_COLOR="Font color. Enclose with quotes."
VAR_HEIGHT="Image height. Default: 1200px."
VAR_OUTPUT_DIR="Output directory. Use an absolute path without a trailing slash. Default: ${script_dir}/outputs"
VAR_SIZE="Font-size. Use a number without px. Default: 120px"
VAR_TEXT="Your text to print."
VAR_WIDTH="Image width. Use a number without px. Default: 1600px."

# remove files in outputs dir
if [ -n "$(ls "${script_dir}"/outputs)" ]; then
    echo "Removing files in $script_dir/outputs."
    rm -- "$script_dir"/outputs/*.*
fi

# shellcheck disable=SC1091
. "${script_dir}/lib/getoptions.sh"

# shellcheck disable=SC1083
parser_definition() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} [command] [options...] [arguments...]"
    msg -- '' 'Options:'
    disp :usage -h --help
    disp VERSION --version

    msg -- '' 'Commands: '
    msg -- 'Use command -h for a command help.'
    cmd 3d -- "3D letters."
    cmd arcade -- "Arcade typography."
    cmd blob -- "Blob text with muliple colors."
    cmd clip -- "Clip image."
    cmd layer -- "Layered text-shadow effect."
    cmd neon -- "Neon light text."
    cmd popart -- "Pop art text."
    cmd retro -- "Retro image."
    cmd split -- "Split text."
    cmd sticker -- "Sticker text."
    cmd strokeshadow -- "Strokes and shadows effects."

    msg -- '' "Examples:
Clip an image 
    $SCRIPT_NAME clip
3D letters
    $SCRIPT_NAME 3d
Arcade typography
    $SCRIPT_NAME arcade
Blob text with muliple colors
    $SCRIPT_NAME blob
Layered text-shadow effect
    $SCRIPT_NAME layer
Neon light text
    $SCRIPT_NAME neon
Pop art effect
    $SCRIPT_NAME popart 
Retro banner: 
    $SCRIPT_NAME retro
Split text: 
    $SCRIPT_NAME split
Sticker text: 
    $SCRIPT_NAME sticker
Strokes and shadows effects
    $SCRIPT_NAME strokeshadow

Display the version:
    $SCRIPT_NAME --version
Display help:
    $SCRIPT_NAME -h | --help
"
}

eval "$(getoptions parser_definition parse "$0") exit 1"
parse "$@"
eval "set -- $REST"

# clip
font_type() {
    case $OPTARG in
    500) FONT_ATT=":wght@500" ;;
    700) FONT_ATT=":wght@700" ;;
    900) FONT_ATT=":wght@900" ;;
    esac
}

FONT_ATT=''
FONT_WEIGHT='500 | 700 | 900'

parser_definition_clip() {
    setup REST plus:true help:usage abbr:true -- \
        "Usage: ${2##*/} clip [options...] [arguments...]" ''

    msg -- 'Creates cliped texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param WEIGHT -b --bold validate:font_type pattern:"$FONT_WEIGHT" -- "Font weight. Choose from 500|700|900."
    param FONT_NAME -f --font init:="Luckiest Guy" -- "Font name. Default: Luckiest Guy."
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param BKIMG -i --image init:="${script_dir}/images/flower.jpg" -- "Background image. Use an absolute path.  Default flower.jpg"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param TEXT -t --text init:="It's Friday." -- "$VAR_TEXT"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    disp :usage -h --help
}

# 3d
parser_definition_3d() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} 3d [options] [arguments]" ''

    msg -- 'Creates 3d texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param BCOLOR -b --bcolor init:="#fbd7e3" -- "$VAR_BCOLOR Default: #fbd7e3"
    param COLOR -c --color init:="#fcdde8" -- "$VAR_COLOR Default: #fcdde8"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param TEXT -t --text init:="Three D" -- "$VAR_TEXT"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    disp :usage -h --help
}

# arcade
parser_definition_arcade() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} arcade [options] [arguments]" ''

    msg -- 'Creates arcade texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param ALIGN -a --align init=:"center" -- "$VAR_ALIGN"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    param TEXT -t --text init:="arcade" -- "$VAR_TEXT"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    disp :usage -h --help
}

# blob
parser_definition_blob() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} arcade [options] [arguments]" ''

    msg -- 'Creates blob texts.'
    msg -- 'All parameters accepts --param value and --param=value form.'

    msg label:"OPTIONS" -- "DESCRIPTION"
    param ALIGN -a --align init=:"center" -- "$VAR_ALIGN"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param TEXT -t --text init:="THE<br>BLOB" -- "$VAR_TEXT"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    disp :usage -h --help
}

# layer
parser_definition_layer() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} layer [options] [arguments]" ''

    msg -- 'Creates layered texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param BCOLOR -b --bcolor init:="#d52e3f" -- "$VAR_BCOLOR Default: #d52e3f"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param TEXT -t --text init:="Teffects" -- "$VAR_TEXT"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    disp :usage -h --help
}

# neon
parser_definition_neon() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} neon [options] [arguments]" ''

    msg -- 'Creates neon texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param ALIGN -a --align init=:"center" -- "$VAR_ALIGN"
    param BCOLOR -b --bcolor init:="#192824" -- "$VAR_BCOLOR Default: #192824"
    param TEXT -t --text init:="Teffects" -- "$VAR_TEXT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    disp :usage -h --help
}

# popart
parser_definition_popart() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} popart [options] [arguments]" ''

    msg -- 'Creates pop art texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param ALIGN -a --align init=:"center" -- "$VAR_ALIGN"
    param BCOLOR -b --bcolor init:="#faff04" -- "$VAR_BCOLOR Default: #faff04"
    param TEXT -t --text init:="Teffects" -- "$VAR_TEXT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    disp :usage -h --help
}

# retro
parser_definition_retro() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} retro [options] [arguments]" ''

    msg -- 'Creates retro texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param SUB_TEXT -s --subtext init:="Text Effect" -- "Subtext. $VAR_TEXT"
    param TEXT -t --text init:="RETRO" -- "$VAR_TEXT"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    disp :usage -h --help
}

# split
parser_definition_split() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} split [options] [arguments]" ''

    msg -- 'Creates split texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param BCOLOR -b --bcolor init:="#000" -- "$VAR_BCOLOR Default: #000"
    param BOCOLOR -o --bocolor init:="#eee" -- "Body color"
    param COLOR -c --color init:="#fff" -- "$VAR_COLOR Default: #fff"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param TEXT -t --text init:="SPLIT" -- "$VAR_TEXT"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    disp :usage -h --help
}

# sticker
parser_definition_sticker() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} sticker [options] [arguments]" ''

    msg -- 'Creates sticker texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    param BCOLOR -b --bcolor init:="#eee" -- "$VAR_BCOLOR Default: #eee"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param LSIZE -l --lsize init:=160 -- "-l 180 will set CSS top font-size: 180px"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param SUB_TEXT -u --subtext init:="Text Effect" -- "Subtext. $VAR_TEXT"
    param TEXT -t --text init:="STICKER" -- "$VAR_TEXT"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    disp :usage -h --help
}

# strokeshadow
parser_definition_strokeshadow() {
    setup REST help:usage abbr:true -- \
        "Usage: ${2##*/} strokeshadow [options] [arguments]" ''

    msg -- 'Creates stroke-shadow texts.'
    msg -- 'All parameters accepts --param value and --param=value form.' ''

    msg label:"OPTIONS" -- "DESCRIPTION"
    flag BEHIND --behind -- "Set the color behind the text."
    param ALIGN -a --align init=:"center" -- "$VAR_ALIGN"
    param BCOLOR -b --bcolor init:="#fef3c7" -- "$VAR_BCOLOR Default: #fef3c7"
    param SCOLOR -c --color init:="#db2777" -- "Shadow color"
    param TEXT -t --text init:="Stroke & shadow" -- "$VAR_TEXT"
    param OUTPUT_DIR -d --dir init:="${script_dir}/outputs" -- "$VAR_OUTPUT_DIR"
    param SIZE -s --size init:=120 -- "$VAR_SIZE"
    param WIDTH -w --width init:="1600" -- "$VAR_WIDTH"
    param HEIGHT -e --height init:="1200" -- "$VAR_HEIGHT"
    disp :usage -h --help
}

if [ $# -gt 0 ]; then
    cmd=$1
    shift
    case $cmd in
    3d)
        echo "3D..."
        eval "$(getoptions parser_definition_3d parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/3d.sh"
        fn_3d "$@"
        ;;
    arcade)
        echo "Arcade ..."
        eval "$(getoptions parser_definition_arcade parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/arcade.sh"
        fn_arcade "$@"
        ;;
    blob)
        echo "Blob ..."
        eval "$(getoptions parser_definition_blob parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/blob.sh"
        fn_blob "$@"
        ;;
    clip)
        echo "Clip ..."
        eval "$(getoptions parser_definition_clip parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/clip.sh"
        fn_clip "$@"
        ;;
    layer)
        echo "Layer ..."
        eval "$(getoptions parser_definition_layer parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/layer.sh"
        fn_layer "$@"
        ;;
    neon)
        echo "Neon ..."
        eval "$(getoptions parser_definition_neon parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/neon.sh"
        fn_neon "$@"
        ;;
    popart)
        echo "Layer ..."
        eval "$(getoptions parser_definition_popart parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/popart.sh"
        fn_popart "$@"
        ;;
    retro)
        echo "Retro ..."
        eval "$(getoptions parser_definition_retro parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/retro.sh"
        fn_retro "$@"
        ;;
    split)
        echo "Split ..."
        eval "$(getoptions parser_definition_split parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/split.sh"
        fn_split "$@"
        ;;
    sticker)
        echo "Sticker ..."
        eval "$(getoptions parser_definition_sticker parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/sticker.sh"
        fn_sticker "$@"
        ;;
    strokeshadow)
        echo "Strokeshadow ..."
        eval "$(getoptions parser_definition_strokeshadow parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/lib/strokeshadow.sh"
        fn_strokeshadow "$@"
        ;;
    --) ;; # no subcommand, arguments only
    esac
fi
